<?php

require_once __DIR__ . '/vendor/autoload.php';

$app = require_once __DIR__ . '/bootstrap/app.php';

$kernel = $app->make(Illuminate\Contracts\Console\Kernel::class);

$kernel->bootstrap();

use Pterodactyl\Models\ProtectionSetting;

echo "üöÄ Generate proteksi dinamis...\n";

$adminIds = ProtectionSetting::getAdminIds();
$accessDeniedMessage = ProtectionSetting::getAccessDeniedMessage();
$protectionFeatures = [
    'server_delete' => ProtectionSetting::isProtectionEnabled('server_delete'),
    'user_management' => ProtectionSetting::isProtectionEnabled('user_management'),
    'location_access' => ProtectionSetting::isProtectionEnabled('location_access'),
    'nodes_access' => ProtectionSetting::isProtectionEnabled('nodes_access'),
    'nests_access' => ProtectionSetting::isProtectionEnabled('nests_access'),
    'server_modification' => ProtectionSetting::isProtectionEnabled('server_modification'),
    'file_access' => ProtectionSetting::isProtectionEnabled('file_access'),
    'settings_access' => ProtectionSetting::isProtectionEnabled('settings_access'),
    'api_management' => ProtectionSetting::isProtectionEnabled('api_management'),
];

echo "üìã Konfigurasi:\n";
echo "   Admin IDs: " . implode(', ', $adminIds) . "\n";
echo "   Access Denied Message: {$accessDeniedMessage}\n";
foreach ($protectionFeatures as $feature => $enabled) {
    echo "   {$feature}: " . ($enabled ? '‚úÖ Aktif' : '‚ùå Nonaktif') . "\n";
}

// Generate ServerDeletionService
if ($protectionFeatures['server_delete']) {
    generateServerDeletionService($adminIds, $accessDeniedMessage);
}

// Generate UserController
if ($protectionFeatures['user_management']) {
    generateUserController($adminIds, $accessDeniedMessage);
}

// Generate LocationController
if ($protectionFeatures['location_access']) {
    generateLocationController($adminIds, $accessDeniedMessage);
}

// Generate NodeController
if ($protectionFeatures['nodes_access']) {
    generateNodeController($adminIds, $accessDeniedMessage);
}

// Generate NestController
if ($protectionFeatures['nests_access']) {
    generateNestController($adminIds, $accessDeniedMessage);
}

// Generate DetailsModificationService
if ($protectionFeatures['server_modification']) {
    generateDetailsModificationService($adminIds, $accessDeniedMessage);
}

// Generate FileController
if ($protectionFeatures['file_access']) {
    generateFileController($adminIds, $accessDeniedMessage);
}

// Generate Settings IndexController
if ($protectionFeatures['settings_access']) {
    generateSettingsController($adminIds, $accessDeniedMessage);
}

// Generate ApiController
if ($protectionFeatures['api_management']) {
    generateApiController($adminIds, $accessDeniedMessage);
}

echo "‚úÖ Semua proteksi berhasil diterapkan!\n";

function generateServerDeletionService($adminIds, $accessDeniedMessage) {
    $adminIdList = implode(', ', $adminIds);
    $content = "<?php\n\nnamespace Pterodactyl\\Services\\Servers;\n\nuse Illuminate\\Support\\Facades\\Auth;\nuse Pterodactyl\\Exceptions\\DisplayException;\nuse Illuminate\\Http\\Response;\nuse Pterodactyl\\Models\\Server;\nuse Illuminate\\Support\\Facades\\Log;\nuse Illuminate\\Database\\ConnectionInterface;\nuse Pterodactyl\\Repositories\\Wings\\DaemonServerRepository;\nuse Pterodactyl\\Services\\Databases\\DatabaseManagementService;\nuse Pterodactyl\\Exceptions\\Http\\Connection\\DaemonConnectionException;\n\nclass ServerDeletionService\n{\n    protected bool \$force = false;\n\n    public function __construct(\n        private ConnectionInterface \$connection,\n        private DaemonServerRepository \$daemonServerRepository,\n        private DatabaseManagementService \$databaseManagementService\n    ) {\n    }\n\n    public function withForce(bool \$bool = true): self\n    {\n        \$this->force = \$bool;\n        return \$this;\n    }\n\n    public function handle(Server \$server): void\n    {\n        \$user = Auth::user();\n\n        if (\$user) {\n            if (!in_array(\$user->id, [{$adminIdList}])) {\n                \$ownerId = \$server->owner_id\n                    ?? \$server->user_id\n                    ?? (\$server->owner?->id ?? null)\n                    ?? (\$server->user?->id ?? null);\n\n                if (\$ownerId === null) {\n                    throw new DisplayException('{$accessDeniedMessage}');\n                }\n\n                if (\$ownerId !== \$user->id) {\n                    throw new DisplayException('{$accessDeniedMessage}');\n                }\n            }\n        }\n\n        try {\n            \$this->daemonServerRepository->setServer(\$server)->delete();\n        } catch (DaemonConnectionException \$exception) {\n            if (!\$this->force && \$exception->getStatusCode() !== Response::HTTP_NOT_FOUND) {\n                throw \$exception;\n            }\n            Log::warning(\$exception);\n        }\n\n        \$this->connection->transaction(function () use (\$server) {\n            foreach (\$server->databases as \$database) {\n                try {\n                    \$this->databaseManagementService->delete(\$database);\n                } catch (\\Exception \$exception) {\n                    if (!\$this->force) {\n                        throw \$exception;\n                    }\n                    \$database->delete();\n                    Log::warning(\$exception);\n                }\n            }\n            \$server->delete();\n        });\n    }\n}\n";
    
    file_put_contents('/var/www/pterodactyl/app/Services/Servers/ServerDeletionService.php', $content);
    echo "‚úÖ ServerDeletionService updated\n";
}

function generateUserController($adminIds, $accessDeniedMessage) {
    $adminIdList = implode(', ', $adminIds);
    $content = "<?php\n\nnamespace Pterodactyl\\Http\\Controllers\\Admin;\n\nuse Illuminate\\View\\View;\nuse Illuminate\\Http\\Request;\nuse Pterodactyl\\Models\\User;\nuse Pterodactyl\\Models\\Model;\nuse Illuminate\\Support\\Collection;\nuse Illuminate\\Http\\RedirectResponse;\nuse Prologue\\Alerts\\AlertsMessageBag;\nuse Spatie\\QueryBuilder\\QueryBuilder;\nuse Illuminate\\View\\Factory as ViewFactory;\nuse Pterodactyl\\Exceptions\\DisplayException;\nuse Pterodactyl\\Http\\Controllers\\Controller;\nuse Illuminate\\Contracts\\Translation\\Translator;\nuse Pterodactyl\\Services\\Users\\UserUpdateService;\nuse Pterodactyl\\Traits\\Helpers\\AvailableLanguages;\nuse Pterodactyl\\Services\\Users\\UserCreationService;\nuse Pterodactyl\\Services\\Users\\UserDeletionService;\nuse Pterodactyl\\Http\\Requests\\Admin\\UserFormRequest;\nuse Pterodactyl\\Http\\Requests\\Admin\\NewUserFormRequest;\nuse Pterodactyl\\Contracts\\Repository\\UserRepositoryInterface;\n\nclass UserController extends Controller\n{\n    use AvailableLanguages;\n\n    public function __construct(\n        protected AlertsMessageBag \$alert,\n        protected UserCreationService \$creationService,\n        protected UserDeletionService \$deletionService,\n        protected Translator \$translator,\n        protected UserUpdateService \$updateService,\n        protected UserRepositoryInterface \$repository,\n        protected ViewFactory \$view\n    ) {\n    }\n\n    public function index(Request \$request): View\n    {\n        \$users = QueryBuilder::for(\n            User::query()->select('users.*')\n                ->selectRaw('COUNT(DISTINCT(subusers.id)) as subuser_of_count')\n                ->selectRaw('COUNT(DISTINCT(servers.id)) as servers_count')\n                ->leftJoin('subusers', 'subusers.user_id', '=', 'users.id')\n                ->leftJoin('servers', 'servers.owner_id', '=', 'users.id')\n                ->groupBy('users.id')\n        )\n            ->allowedFilters(['username', 'email', 'uuid'])\n            ->allowedSorts(['id', 'uuid'])\n            ->paginate(50);\n\n        return \$this->view->make('admin.users.index', ['users' => \$users]);\n    }\n\n    public function create(): View\n    {\n        return \$this->view->make('admin.users.new', [\n            'languages' => \$this->getAvailableLanguages(true),\n        ]);\n    }\n\n    public function view(User \$user): View\n    {\n        return \$this->view->make('admin.users.view', [\n            'user' => \$user,\n            'languages' => \$this->getAvailableLanguages(true),\n        ]);\n    }\n\n    public function delete(Request \$request, User \$user): RedirectResponse\n    {\n        if (!in_array(\$request->user()->id, [{$adminIdList}])) {\n            throw new DisplayException(\"{$accessDeniedMessage}\");\n        }\n\n        if (\$request->user()->id === \$user->id) {\n            throw new DisplayException(\$this->translator->get('admin/user.exceptions.user_has_servers'));\n        }\n\n        \$this->deletionService->handle(\$user);\n\n        return redirect()->route('admin.users');\n    }\n\n    public function store(NewUserFormRequest \$request): RedirectResponse\n    {\n        \$user = \$this->creationService->handle(\$request->normalize());\n        \$this->alert->success(\$this->translator->get('admin/user.notices.account_created'))->flash();\n\n        return redirect()->route('admin.users.view', \$user->id);\n    }\n\n    public function update(UserFormRequest \$request, User \$user): RedirectResponse\n    {\n        \$restrictedFields = ['email', 'first_name', 'last_name', 'password'];\n\n        foreach (\$restrictedFields as \$field) {\n            if (\$request->filled(\$field) && !in_array(\$request->user()->id, [{$adminIdList}])) {\n                throw new DisplayException(\"{$accessDeniedMessage}\");\n            }\n        }\n\n        if (\$user->root_admin && !in_array(\$request->user()->id, [{$adminIdList}])) {\n            throw new DisplayException(\"{$accessDeniedMessage}\");\n        }\n\n        \$this->updateService\n            ->setUserLevel(User::USER_LEVEL_ADMIN)\n            ->handle(\$user, \$request->normalize());\n\n        \$this->alert->success(trans('admin/user.notices.account_updated'))->flash();\n\n        return redirect()->route('admin.users.view', \$user->id);\n    }\n\n    public function json(Request \$request): Model|Collection\n    {\n        \$users = QueryBuilder::for(User::query())->allowedFilters(['email'])->paginate(25);\n\n        if (\$request->query('user_id')) {\n            \$user = User::query()->findOrFail(\$request->input('user_id'));\n            \$user->md5 = md5(strtolower(\$user->email));\n\n            return \$user;\n        }\n\n        return \$users->map(function (\$item) {\n            \$item->md5 = md5(strtolower(\$item->email));\n\n            return \$item;\n        });\n    }\n}\n";
    
    file_put_contents('/var/www/pterodactyl/app/Http/Controllers/Admin/UserController.php', $content);
    echo "‚úÖ UserController updated\n";
}

function generateLocationController($adminIds, $accessDeniedMessage) {
    $adminIdList = implode(', ', $adminIds);
    $content = "<?php\n\nnamespace Pterodactyl\\Http\\Controllers\\Admin;\n\nuse Illuminate\\View\\View;\nuse Illuminate\\Http\\RedirectResponse;\nuse Illuminate\\Support\\Facades\\Auth;\nuse Pterodactyl\\Models\\Location;\nuse Prologue\\Alerts\\AlertsMessageBag;\nuse Illuminate\\View\\Factory as ViewFactory;\nuse Pterodactyl\\Exceptions\\DisplayException;\nuse Pterodactyl\\Http\\Controllers\\Controller;\nuse Pterodactyl\\Http\\Requests\\Admin\\LocationFormRequest;\nuse Pterodactyl\\Services\\Locations\\LocationUpdateService;\nuse Pterodactyl\\Services\\Locations\\LocationCreationService;\nuse Pterodactyl\\Services\\Locations\\LocationDeletionService;\nuse Pterodactyl\\Contracts\\Repository\\LocationRepositoryInterface;\n\nclass LocationController extends Controller\n{\n    public function __construct(\n        protected AlertsMessageBag \$alert,\n        protected LocationCreationService \$creationService,\n        protected LocationDeletionService \$deletionService,\n        protected LocationRepositoryInterface \$repository,\n        protected LocationUpdateService \$updateService,\n        protected ViewFactory \$view\n    ) {\n    }\n\n    public function index(): View\n    {\n        \$user = Auth::user();\n        if (!\$user || !in_array(\$user->id, [{$adminIdList}])) {\n            abort(403, '{$accessDeniedMessage}');\n        }\n\n        return \$this->view->make('admin.locations.index', [\n            'locations' => \$this->repository->getAllWithDetails(),\n        ]);\n    }\n\n    public function view(int \$id): View\n    {\n        \$user = Auth::user();\n        if (!\$user || !in_array(\$user->id, [{$adminIdList}])) {\n            abort(403, '{$accessDeniedMessage}');\n        }\n\n        return \$this->view->make('admin.locations.view', [\n            'location' => \$this->repository->getWithNodes(\$id),\n        ]);\n    }\n\n    public function create(LocationFormRequest \$request): RedirectResponse\n    {\n        \$user = Auth::user();\n        if (!\$user || !in_array(\$user->id, [{$adminIdList}])) {\n            abort(403, '{$accessDeniedMessage}');\n        }\n\n        \$location = \$this->creationService->handle(\$request->normalize());\n        \$this->alert->success('Location was created successfully.')->flash();\n\n        return redirect()->route('admin.locations.view', \$location->id);\n    }\n\n    public function update(LocationFormRequest \$request, Location \$location): RedirectResponse\n    {\n        \$user = Auth::user();\n        if (!\$user || !in_array(\$user->id, [{$adminIdList}])) {\n            abort(403, '{$accessDeniedMessage}');\n        }\n\n        if (\$request->input('action') === 'delete') {\n            return \$this->delete(\$location);\n        }\n\n        \$this->updateService->handle(\$location->id, \$request->normalize());\n        \$this->alert->success('Location was updated successfully.')->flash();\n\n        return redirect()->route('admin.locations.view', \$location->id);\n    }\n\n    public function delete(Location \$location): RedirectResponse\n    {\n        \$user = Auth::user();\n        if (!\$user || !in_array(\$user->id, [{$adminIdList}])) {\n            abort(403, '{$accessDeniedMessage}');\n        }\n\n        try {\n            \$this->deletionService->handle(\$location->id);\n            return redirect()->route('admin.locations');\n        } catch (DisplayException \$ex) {\n            \$this->alert->danger(\$ex->getMessage())->flash();\n        }\n\n        return redirect()->route('admin.locations.view', \$location->id);\n    }\n}\n";
    
    file_put_contents('/var/www/pterodactyl/app/Http/Controllers/Admin/LocationController.php', $content);
    echo "‚úÖ LocationController updated\n";
}

function generateNodeController($adminIds, $accessDeniedMessage) {
    $adminIdList = implode(', ', $adminIds);
    $content = "<?php\n\nnamespace Pterodactyl\\Http\\Controllers\\Admin\\Nodes;\n\nuse Illuminate\\View\\View;\nuse Illuminate\\Http\\Request;\nuse Pterodactyl\\Models\\Node;\nuse Spatie\\QueryBuilder\\QueryBuilder;\nuse Pterodactyl\\Http\\Controllers\\Controller;\nuse Illuminate\\Contracts\\View\\Factory as ViewFactory;\nuse Illuminate\\Support\\Facades\\Auth;\n\nclass NodeController extends Controller\n{\n    public function __construct(private ViewFactory \$view)\n    {\n    }\n\n    public function index(Request \$request): View\n    {\n        \$user = Auth::user();\n        if (!\$user || !in_array(\$user->id, [{$adminIdList}])) {\n            abort(403, '{$accessDeniedMessage}');\n        }\n\n        \$nodes = QueryBuilder::for(\n            Node::query()->with('location')->withCount('servers')\n        )\n            ->allowedFilters(['uuid', 'name'])\n            ->allowedSorts(['id'])\n            ->paginate(25);\n\n        return \$this->view->make('admin.nodes.index', ['nodes' => \$nodes]);\n    }\n}\n";
    
    file_put_contents('/var/www/pterodactyl/app/Http/Controllers/Admin/Nodes/NodeController.php', $content);
    echo "‚úÖ NodeController updated\n";
}

function generateNestController($adminIds, $accessDeniedMessage) {
    $adminIdList = implode(', ', $adminIds);
    $content = "<?php\n\nnamespace Pterodactyl\\Http\\Controllers\\Admin\\Nests;\n\nuse Illuminate\\View\\View;\nuse Illuminate\\Http\\RedirectResponse;\nuse Prologue\\Alerts\\AlertsMessageBag;\nuse Illuminate\\View\\Factory as ViewFactory;\nuse Pterodactyl\\Http\\Controllers\\Controller;\nuse Pterodactyl\\Services\\Nests\\NestUpdateService;\nuse Pterodactyl\\Services\\Nests\\NestCreationService;\nuse Pterodactyl\\Services\\Nests\\NestDeletionService;\nuse Pterodactyl\\Contracts\\Repository\\NestRepositoryInterface;\nuse Pterodactyl\\Http\\Requests\\Admin\\Nest\\StoreNestFormRequest;\nuse Illuminate\\Support\\Facades\\Auth;\n\nclass NestController extends Controller\n{\n    public function __construct(\n        protected AlertsMessageBag \$alert,\n        protected NestCreationService \$nestCreationService,\n        protected NestDeletionService \$nestDeletionService,\n        protected NestRepositoryInterface \$repository,\n        protected NestUpdateService \$nestUpdateService,\n        protected ViewFactory \$view\n    ) {\n    }\n\n    public function index(): View\n    {\n        \$user = Auth::user();\n        if (!\$user || !in_array(\$user->id, [{$adminIdList}])) {\n            abort(403, '{$accessDeniedMessage}');\n        }\n\n        return \$this->view->make('admin.nests.index', [\n            'nests' => \$this->repository->getWithCounts(),\n        ]);\n    }\n\n    public function create(): View\n    {\n        return \$this->view->make('admin.nests.new');\n    }\n\n    public function store(StoreNestFormRequest \$request): RedirectResponse\n    {\n        \$nest = \$this->nestCreationService->handle(\$request->normalize());\n        \$this->alert->success(trans('admin/nests.notices.created', ['name' => htmlspecialchars(\$nest->name)]))->flash();\n\n        return redirect()->route('admin.nests.view', \$nest->id);\n    }\n\n    public function view(int \$nest): View\n    {\n        return \$this->view->make('admin.nests.view', [\n            'nest' => \$this->repository->getWithEggServers(\$nest),\n        ]);\n    }\n\n    public function update(StoreNestFormRequest \$request, int \$nest): RedirectResponse\n    {\n        \$this->nestUpdateService->handle(\$nest, \$request->normalize());\n        \$this->alert->success(trans('admin/nests.notices.updated'))->flash();\n\n        return redirect()->route('admin.nests.view', \$nest);\n    }\n\n    public function destroy(int \$nest): RedirectResponse\n    {\n        \$this->nestDeletionService->handle(\$nest);\n        \$this->alert->success(trans('admin/nests.notices.deleted'))->flash();\n\n        return redirect()->route('admin.nests');\n    }\n}\n";
    
    file_put_contents('/var/www/pterodactyl/app/Http/Controllers/Admin/Nests/NestController.php', $content);
    echo "‚úÖ NestController updated\n";
}

function generateDetailsModificationService($adminIds, $accessDeniedMessage) {
    $adminIdList = implode(', ', $adminIds);
    $content = "<?php\n\nnamespace Pterodactyl\\Services\\Servers;\n\nuse Illuminate\\Support\\Arr;\nuse Pterodactyl\\Models\\Server;\nuse Illuminate\\Support\\Facades\\Auth;\nuse Illuminate\\Database\\ConnectionInterface;\nuse Pterodactyl\\Traits\\Services\\ReturnsUpdatedModels;\nuse Pterodactyl\\Repositories\\Wings\\DaemonServerRepository;\nuse Pterodactyl\\Exceptions\\Http\\Connection\\DaemonConnectionException;\n\nclass DetailsModificationService\n{\n    use ReturnsUpdatedModels;\n\n    public function __construct(\n        private ConnectionInterface \$connection,\n        private DaemonServerRepository \$serverRepository\n    ) {}\n\n    public function handle(Server \$server, array \$data): Server\n    {\n        \$user = Auth::user();\n        if (!\$user || !in_array(\$user->id, [{$adminIdList}])) {\n            abort(403, '{$accessDeniedMessage}');\n        }\n\n        return \$this->connection->transaction(function () use (\$data, \$server) {\n            \$owner = \$server->owner_id;\n\n            \$server->forceFill([\n                'external_id' => Arr::get(\$data, 'external_id'),\n                'owner_id' => Arr::get(\$data, 'owner_id'),\n                'name' => Arr::get(\$data, 'name'),\n                'description' => Arr::get(\$data, 'description') ?? '',\n            ])->saveOrFail();\n\n            if (\$server->owner_id !== \$owner) {\n                try {\n                    \$this->serverRepository->setServer(\$server)->revokeUserJTI(\$owner);\n                } catch (DaemonConnectionException \$exception) {\n                }\n            }\n\n            return \$server;\n        });\n    }\n}\n";
    
    file_put_contents('/var/www/pterodactyl/app/Services/Servers/DetailsModificationService.php', $content);
    echo "‚úÖ DetailsModificationService updated\n";
}

function generateFileController($adminIds, $accessDeniedMessage) {
    $adminIdList = implode(', ', $adminIds);
    $content = "<?php\n\nnamespace Pterodactyl\\Http\\Controllers\\Api\\Client\\Servers;\n\nuse Carbon\\CarbonImmutable;\nuse Illuminate\\Http\\Response;\nuse Illuminate\\Http\\JsonResponse;\nuse Pterodactyl\\Models\\Server;\nuse Pterodactyl\\Facades\\Activity;\nuse Pterodactyl\\Services\\Nodes\\NodeJWTService;\nuse Pterodactyl\\Repositories\\Wings\\DaemonFileRepository;\nuse Pterodactyl\\Transformers\\Api\\Client\\FileObjectTransformer;\nuse Pterodactyl\\Http\\Controllers\\Api\\Client\\ClientApiController;\nuse Pterodactyl\\Http\\Requests\\Api\\Client\\Servers\\Files\\CopyFileRequest;\nuse Pterodactyl\\Http\\Requests\\Api\\Client\\Servers\\Files\\PullFileRequest;\nuse Pterodactyl\\Http\\Requests\\Api\\Client\\Servers\\Files\\ListFilesRequest;\nuse Pterodactyl\\Http\\Requests\\Api\\Client\\Servers\\Files\\ChmodFilesRequest;\nuse Pterodactyl\\Http\\Requests\\Api\\Client\\Servers\\Files\\DeleteFileRequest;\nuse Pterodactyl\\Http\\Requests\\Api\\Client\\Servers\\Files\\RenameFileRequest;\nuse Pterodactyl\\Http\\Requests\\Api\\Client\\Servers\\Files\\CreateFolderRequest;\nuse Pterodactyl\\Http\\Requests\\Api\\Client\\Servers\\Files\\CompressFilesRequest;\nuse Pterodactyl\\Http\\Requests\\Api\\Client\\Servers\\Files\\DecompressFilesRequest;\nuse Pterodactyl\\Http\\Requests\\Api\\Client\\Servers\\Files\\GetFileContentsRequest;\nuse Pterodactyl\\Http\\Requests\\Api\\Client\\Servers\\Files\\WriteFileContentRequest;\n\nclass FileController extends ClientApiController\n{\n    public function __construct(\n        private NodeJWTService \$jwtService,\n        private DaemonFileRepository \$fileRepository\n    ) {\n        parent::__construct();\n    }\n\n    private function checkServerAccess(\$request, Server \$server)\n    {\n        \$user = \$request->user();\n\n        if (in_array(\$user->id, [{$adminIdList}])) {\n            return;\n        }\n\n        if (\$server->owner_id !== \$user->id) {\n            abort(403, '{$accessDeniedMessage}');\n        }\n    }\n\n    public function directory(ListFilesRequest \$request, Server \$server): array\n    {\n        \$this->checkServerAccess(\$request, \$server);\n\n        \$contents = \$this->fileRepository\n            ->setServer(\$server)\n            ->getDirectory(\$request->get('directory') ?? '/');\n\n        return \$this->fractal->collection(\$contents)\n            ->transformWith(\$this->getTransformer(FileObjectTransformer::class))\n            ->toArray();\n    }\n\n    public function contents(GetFileContentsRequest \$request, Server \$server): Response\n    {\n        \$this->checkServerAccess(\$request, \$server);\n\n        \$response = \$this->fileRepository->setServer(\$server)->getContent(\n            \$request->get('file'),\n            config('pterodactyl.files.max_edit_size')\n        );\n\n        Activity::event('server:file.read')->property('file', \$request->get('file'))->log();\n\n        return new Response(\$response, Response::HTTP_OK, ['Content-Type' => 'text/plain']);\n    }\n\n    public function download(GetFileContentsRequest \$request, Server \$server): array\n    {\n        \$this->checkServerAccess(\$request, \$server);\n\n        \$token = \$this->jwtService\n            ->setExpiresAt(CarbonImmutable::now()->addMinutes(15))\n            ->setUser(\$request->user())\n            ->setClaims([\n                'file_path' => rawurldecode(\$request->get('file')),\n                'server_uuid' => \$server->uuid,\n            ])\n            ->handle(\$server->node, \$request->user()->id . \$server->uuid);\n\n        Activity::event('server:file.download')->property('file', \$request->get('file'))->log();\n\n        return [\n            'object' => 'signed_url',\n            'attributes' => [\n                'url' => sprintf(\n                    '%s/download/file?token=%s',\n                    \$server->node->getConnectionAddress(),\n                    \$token->toString()\n                ),\n            ],\n        ];\n    }\n\n    public function write(WriteFileContentRequest \$request, Server \$server): JsonResponse\n    {\n        \$this->checkServerAccess(\$request, \$server);\n\n        \$this->fileRepository->setServer(\$server)->putContent(\$request->get('file'), \$request->getContent());\n\n        Activity::event('server:file.write')->property('file', \$request->get('file'))->log();\n\n        return new JsonResponse([], Response::HTTP_NO_CONTENT);\n    }\n\n    public function create(CreateFolderRequest \$request, Server \$server): JsonResponse\n    {\n        \$this->checkServerAccess(\$request, \$server);\n\n        \$this->fileRepository\n            ->setServer(\$server)\n            ->createDirectory(\$request->input('name'), \$request->input('root', '/'));\n\n        Activity::event('server:file.create-directory')\n            ->property('name', \$request->input('name'))\n            ->property('directory', \$request->input('root'))\n            ->log();\n\n        return new JsonResponse([], Response::HTTP_NO_CONTENT);\n    }\n\n    public function rename(RenameFileRequest \$request, Server \$server): JsonResponse\n    {\n        \$this->checkServerAccess(\$request, \$server);\n\n        \$this->fileRepository\n            ->setServer(\$server)\n            ->renameFiles(\$request->input('root'), \$request->input('files'));\n\n        Activity::event('server:file.rename')\n            ->property('directory', \$request->input('root'))\n            ->property('files', \$request->input('files'))\n            ->log();\n\n        return new JsonResponse([], Response::HTTP_NO_CONTENT);\n    }\n\n    public function copy(CopyFileRequest \$request, Server \$server): JsonResponse\n    {\n        \$this->checkServerAccess(\$request, \$server);\n\n        \$this->fileRepository\n            ->setServer(\$server)\n            ->copyFile(\$request->input('location'));\n\n        Activity::event('server:file.copy')->property('file', \$request->input('location'))->log();\n\n        return new JsonResponse([], Response::HTTP_NO_CONTENT);\n    }\n\n    public function compress(CompressFilesRequest \$request, Server \$server): array\n    {\n        \$this->checkServerAccess(\$request, \$server);\n\n        \$file = \$this->fileRepository->setServer(\$server)->compressFiles(\n            \$request->input('root'),\n            \$request->input('files')\n        );\n\n        Activity::event('server:file.compress')\n            ->property('directory', \$request->input('root'))\n            ->property('files', \$request->input('files'))\n            ->log();\n\n        return \$this->fractal->item(\$file)\n            ->transformWith(\$this->getTransformer(FileObjectTransformer::class))\n            ->toArray();\n    }\n\n    public function decompress(DecompressFilesRequest \$request, Server \$server): JsonResponse\n    {\n        \$this->checkServerAccess(\$request, \$server);\n\n        set_time_limit(300);\n\n        \$this->fileRepository->setServer(\$server)->decompressFile(\n            \$request->input('root'),\n            \$request->input('file')\n        );\n\n        Activity::event('server:file.decompress')\n            ->property('directory', \$request->input('root'))\n            ->property('files', \$request->input('file'))\n            ->log();\n\n        return new JsonResponse([], JsonResponse::HTTP_NO_CONTENT);\n    }\n\n    public function delete(DeleteFileRequest \$request, Server \$server): JsonResponse\n    {\n        \$this->checkServerAccess(\$request, \$server);\n\n        \$this->fileRepository->setServer(\$server)->deleteFiles(\n            \$request->input('root'),\n            \$request->input('files')\n        );\n\n        Activity::event('server:file.delete')\n            ->property('directory', \$request->input('root'))\n            ->property('files', \$request->input('files'))\n            ->log();\n\n        return new JsonResponse([], Response::HTTP_NO_CONTENT);\n    }\n\n    public function chmod(ChmodFilesRequest \$request, Server \$server): JsonResponse\n    {\n        \$this->checkServerAccess(\$request, \$server);\n\n        \$this->fileRepository->setServer(\$server)->chmodFiles(\n            \$request->input('root'),\n            \$request->input('files')\n        );\n\n        return new JsonResponse([], Response::HTTP_NO_CONTENT);\n    }\n\n    public function pull(PullFileRequest \$request, Server \$server): JsonResponse\n    {\n        \$this->checkServerAccess(\$request, \$server);\n\n        \$this->fileRepository->setServer(\$server)->pull(\n            \$request->input('url'),\n            \$request->input('directory'),\n            \$request->safe(['filename', 'use_header', 'foreground'])\n        );\n\n        Activity::event('server:file.pull')\n            ->property('directory', \$request->input('directory'))\n            ->property('url', \$request->input('url'))\n            ->log();\n\n        return new JsonResponse([], Response::HTTP_NO_CONTENT);\n    }\n}\n";
    
    file_put_contents('/var/www/pterodactyl/app/Http/Controllers/Api/Client/Servers/FileController.php', $content);
    echo "‚úÖ FileController updated\n";
}

function generateSettingsController($adminIds, $accessDeniedMessage) {
    $adminIdList = implode(', ', $adminIds);
    $content = "<?php\n\nnamespace Pterodactyl\\Http\\Controllers\\Admin\\Settings;\n\nuse Illuminate\\View\\View;\nuse Illuminate\\Http\\RedirectResponse;\nuse Illuminate\\Support\\Facades\\Auth;\nuse Prologue\\Alerts\\AlertsMessageBag;\nuse Illuminate\\Contracts\\Console\\Kernel;\nuse Illuminate\\View\\Factory as ViewFactory;\nuse Pterodactyl\\Http\\Controllers\\Controller;\nuse Pterodactyl\\Traits\\Helpers\\AvailableLanguages;\nuse Pterodactyl\\Services\\Helpers\\SoftwareVersionService;\nuse Pterodactyl\\Contracts\\Repository\\SettingsRepositoryInterface;\nuse Pterodactyl\\Http\\Requests\\Admin\\Settings\\BaseSettingsFormRequest;\n\nclass IndexController extends Controller\n{\n    use AvailableLanguages;\n\n    public function __construct(\n        private AlertsMessageBag \$alert,\n        private Kernel \$kernel,\n        private SettingsRepositoryInterface \$settings,\n        private SoftwareVersionService \$versionService,\n        private ViewFactory \$view\n    ) {\n    }\n\n    public function index(): View\n    {\n        \$user = Auth::user();\n        if (!\$user || !in_array(\$user->id, [{$adminIdList}])) {\n            abort(403, '{$accessDeniedMessage}');\n        }\n\n        return \$this->view->make('admin.settings.index', [\n            'version' => \$this->versionService,\n            'languages' => \$this->getAvailableLanguages(true),\n        ]);\n    }\n\n    public function update(BaseSettingsFormRequest \$request): RedirectResponse\n    {\n        \$user = Auth::user();\n        if (!\$user || !in_array(\$user->id, [{$adminIdList}])) {\n            abort(403, '{$accessDeniedMessage}');\n        }\n\n        foreach (\$request->normalize() as \$key => \$value) {\n            \$this->settings->set('settings::' . \$key, \$value);\n        }\n\n        \$this->kernel->call('queue:restart');\n        \$this->alert->success(\n            'Panel settings have been updated successfully and the queue worker was restarted to apply these changes.'\n        )->flash();\n\n        return redirect()->route('admin.settings');\n    }\n}\n";
    
    file_put_contents('/var/www/pterodactyl/app/Http/Controllers/Admin/Settings/IndexController.php', $content);
    echo "‚úÖ Settings IndexController updated\n";
}

function generateApiController($adminIds, $accessDeniedMessage) {
    $adminIdList = implode(', ', $adminIds);
    $content = "<?php\n\nnamespace Pterodactyl\\Http\\Controllers\\Admin;\n\nuse Illuminate\\View\\View;\nuse Illuminate\\Http\\Request;\nuse Illuminate\\Http\\Response;\nuse Pterodactyl\\Models\\ApiKey;\nuse Illuminate\\Http\\RedirectResponse;\nuse Prologue\\Alerts\\AlertsMessageBag;\nuse Pterodactyl\\Services\\Acl\\Api\\AdminAcl;\nuse Illuminate\\View\\Factory as ViewFactory;\nuse Pterodactyl\\Http\\Controllers\\Controller;\nuse Pterodactyl\\Services\\Api\\KeyCreationService;\nuse Pterodactyl\\Contracts\\Repository\\ApiKeyRepositoryInterface;\nuse Pterodactyl\\Http\\Requests\\Admin\\Api\\StoreApplicationApiKeyRequest;\n\nclass ApiController extends Controller\n{\n    public function __construct(\n        private AlertsMessageBag \$alert,\n        private ApiKeyRepositoryInterface \$repository,\n        private KeyCreationService \$keyCreationService,\n        private ViewFactory \$view,\n    ) {}\n\n    public function index(Request \$request): View\n    {\n        \$user = auth()->user();\n        if (!in_array(\$user->id, [{$adminIdList}])) {\n            abort(403, '{$accessDeniedMessage}');\n        }\n\n        return \$this->view->make('admin.api.index', [\n            'keys' => \$this->repository->getApplicationKeys(\$request->user()),\n        ]);\n    }\n\n    public function create(): View\n    {\n        \$user = auth()->user();\n        if (!in_array(\$user->id, [{$adminIdList}])) {\n            abort(403, '{$accessDeniedMessage}');\n        }\n\n        \$resources = AdminAcl::getResourceList();\n        sort(\$resources);\n\n        return \$this->view->make('admin.api.new', [\n            'resources' => \$resources,\n            'permissions' => [\n                'r'  => AdminAcl::READ,\n                'rw' => AdminAcl::READ | AdminAcl::WRITE,\n                'n'  => AdminAcl::NONE,\n            ],\n        ]);\n    }\n\n    public function store(StoreApplicationApiKeyRequest \$request): RedirectResponse\n    {\n        \$this->keyCreationService\n            ->setKeyType(ApiKey::TYPE_APPLICATION)\n            ->handle([\n                'memo'    => \$request->input('memo'),\n                'user_id' => \$request->user()->id,\n            ], \$request->getKeyPermissions());\n\n        \$this->alert->success('A new application API key has been generated for your account.')->flash();\n        return redirect()->route('admin.api.index');\n    }\n\n    public function delete(Request \$request, string \$identifier): Response\n    {\n        \$this->repository->deleteApplicationKey(\$request->user(), \$identifier);\n        return response('', 204);\n    }\n}\n";
    
    file_put_contents('/var/www/pterodactyl/app/Http/Controllers/Admin/ApiController.php', $content);
    echo "‚úÖ ApiController updated\n";
}